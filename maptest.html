<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ» æ‰©å¤§å†…å®¹æ¡† + å›¾æ–‡å±•ç¤º</title>
    <!-- é«˜å¾·åœ°å›¾å®‰å…¨å¯†é’¥é…ç½®ï¼ˆå¿…é¡»æ”¾åœ¨APIåŠ è½½ä¹‹å‰ï¼‰ -->
    <script>
        window._AMapSecurityConfig = {
            securityJsCode: '3c73c58ae84081248aa67daefac32179', // è¯·æ›¿æ¢ä¸ºä½ çš„çœŸå®å®‰å…¨å¯†é’¥
        };
    </script>
    <style>
        /* æ•´ä½“å¸ƒå±€ */
        .page-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }
        .tips {
            text-align: center;
            color: #666;
            margin: 5px 0 15px;
            font-size: 14px;
        }
        /* å°å‹æ ·å¼åˆ‡æ¢å™¨ï¼ˆç®­å¤´+å½“å‰æ ·å¼åï¼‰ */
        .style-switcher {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 10px;
            background-color: #f8f8f8;
            border-radius: 30px;
            padding: 6px 20px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .style-switcher button {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .style-switcher button:hover {
            background-color: #e0e0e0;
        }
        .style-switcher span {
            font-size: 16px;
            min-width: 80px;
            text-align: center;
            font-weight: 500;
        }
        /* åœ°å›¾å’Œç¼©æ”¾æŒ‰é’®è¡Œ */
        .map-row {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 15px;
            justify-content: center;
        }
        /* æ­£æ–¹å½¢åœ°å›¾å®¹å™¨ */
        #mapContainer {
            width: 600px;
            height: 600px;        /* æ­£æ–¹å½¢ */
            border: 1px solid #ccc;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        /* å³ä¾§ç¼©æ”¾æŒ‰é’®ç»„ */
        .zoom-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 10px;
        }
        .zoom-buttons button {
            width: 60px;
            height: 60px;
            font-size: 28px;
            font-weight: bold;
            border: none;
            background-color: #f5f5f5;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .zoom-buttons button:hover {
            background-color: #e0e0e0;
        }
        .zoom-buttons button:active {
            background-color: #d0d0d0;
        }
        /* ä¸‹æ–¹æŒ‰é’®ç»„ */
        .button-wrapper {
            text-align: center;
            margin: 20px 0;
        }
        .button-wrapper button {
            font-size: 16px;
            padding: 8px 20px;
            margin: 0 5px;
            cursor: pointer;
        }
        /* æ‰©å¤§åçš„ä¿¡æ¯æ˜¾ç¤ºæ¡† */
        .info-box {
            width: 600px;
            min-height: 200px;        /* å¢å¤§æœ€å°é«˜åº¦ï¼Œå¯å®¹çº³æ›´å¤šå†…å®¹ */
            margin: 10px auto;
            padding: 20px 25px;        /* å¢å¤§å†…è¾¹è· */
            background-color: #f9f9fc;
            border: 1px solid #d0e0f0;
            border-radius: 12px;
            font-size: 16px;
            color: #1e2b3a;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            line-height: 1.6;
            overflow-y: auto;          /* å†…å®¹è¿‡å¤šæ—¶æ»šåŠ¨ */
            box-sizing: border-box;
        }
        .info-box .label {
            font-weight: 600;
            color: #1e6f9f;
            display: block;
            margin-bottom: 10px;
            font-size: 18px;
        }
        .info-box img {
            vertical-align: middle;
            margin-right: 10px;
            border-radius: 8px;
        }
        /* æ ‡è®°æ ·å¼ */
        .bear-marker {
            font-size: 36px;
            cursor: pointer;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }
        .star-marker {
            font-size: 32px;
            cursor: pointer;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }
        .bear-marker:hover, .star-marker:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="tips">
            ğŸŒŸ èšŒåŸ å…¥å£ï¼ˆç¼©æ”¾<7æ—¶å¯è§ï¼‰ç‚¹å‡»å¯æ”¾å¤§åœ°å›¾è‡³èšŒåŸ <br>
            ğŸ» å°ç†Šæ˜¾ç¤ºä¸Šæ¬¡å®šä½ï¼ˆè‹¥æœ‰ï¼‰ï¼Œç‚¹å‡»æŒ‰é’®å¯æ›´æ–°ä½ç½®<br>
            â•â– å³ä¾§æŒ‰é’®å¯ç¼©æ”¾åœ°å›¾
        </div>

        <!-- å°å‹æ ·å¼åˆ‡æ¢å™¨ï¼šå·¦å³ç®­å¤´ + å½“å‰æ ·å¼åç§° -->
        <div class="style-switcher">
            <button id="stylePrevBtn" title="ä¸Šä¸€ä¸ªæ ·å¼">â—€</button>
            <span id="currentStyleName">æ ‡å‡†</span>
            <button id="styleNextBtn" title="ä¸‹ä¸€ä¸ªæ ·å¼">â–¶</button>
        </div>

        <!-- ç¬¬ä¸€è¡Œï¼šæ­£æ–¹å½¢åœ°å›¾ + å³ä¾§ç¼©æ”¾æŒ‰é’® -->
        <div class="map-row">
            <div id="mapContainer"></div>
            <div class="zoom-buttons">
                <button id="zoomInBtn" title="æ”¾å¤§">+</button>
                <button id="zoomOutBtn" title="ç¼©å°">-</button>
            </div>
        </div>

        <!-- æ‰©å¤§åçš„ä¿¡æ¯æ˜¾ç¤ºæ¡†ï¼šå¯æ˜¾ç¤ºå›¾æ–‡ -->
        <div id="clickInfo" class="info-box">
            <span class="label">ğŸ» å°ç†Šä¿¡æ¯</span>
            <div style="display: flex; align-items: center; gap: 15px;">
                <img src="https://img.icons8.com/color/96/000000/bear.png" width="48" height="48" alt="å°ç†Šå›¾æ ‡">
                <span>ç‚¹å‡»åœ°å›¾ä¸Šçš„å°ç†Šæ ‡è®°ï¼ŒæŸ¥çœ‹è¯¦ç»†ä½ç½®ä¿¡æ¯ã€‚<br>æœ¬æ¡†æ”¯æŒå›¾æ–‡æ··æ’ï¼Œå¯æ˜¾ç¤ºæ–‡å­—å’Œå›¾ç‰‡ã€‚</span>
            </div>
        </div>

        <!-- ç¬¬äºŒè¡Œï¼šåŸæœ‰åŠŸèƒ½æŒ‰é’® -->
        <div class="button-wrapper">
            <button id="locateBtn">æ›´æ–°ä½ç½®</button>
            <button id="resetBtn">é‡ç½®è§†å›¾</button>
        </div>
    </div>

    <script>
        // é«˜å¾·åœ°å›¾Key
        const AMAP_KEY = "9f623094f7f5e1b9b8ae58be7f213915";

        // å­˜å‚¨é”®å
        const STORAGE_KEY = 'AMAP_USER_LOCATION';
        const STYLE_STORAGE_KEY = 'MAP_STYLE_INDEX'; // ç”¨äºè®°ä½åœ°å›¾é£æ ¼ç´¢å¼•

        // é¢„å®šä¹‰styleIdåˆ—è¡¨ï¼ˆä½¿ç”¨å®˜æ–¹å®Œæ•´URLæ ¼å¼ï¼‰
        const STYLES = [
            { id: 'amap://styles/normal', name: 'æ ‡å‡†' },
            { id: 'amap://styles/dark', name: 'å¹»å½±é»‘' },
            { id: 'amap://styles/light', name: 'æœˆå…‰é“¶' },
            { id: 'amap://styles/whitesmoke', name: 'è¿œå±±é»›' },
            { id: 'amap://styles/grey', name: 'é›…å£«ç°' },
            { id: 'amap://styles/fresh', name: 'è‰è‰²é’' },
            { id: 'amap://styles/graffiti', name: 'æ¶‚é¸¦' },
            { id: 'amap://styles/macaron', name: 'é©¬å¡é¾™' },
            { id: 'amap://styles/blue', name: 'é›é’è“' },
            { id: 'amap://styles/darkblue', name: 'æå¤œè“' },
            { id: 'amap://styles/wine', name: 'é…±ç±½' }
        ];
        let currentStyleIndex = 0;  // é»˜è®¤ç´¢å¼•0ï¼ˆnormalï¼‰

        // å…¨å±€å˜é‡
        let map = null;
        let currentUserMarker = null;      // å°ç†Šæ ‡è®°
        let bengbuEntryMarker = null;      // èšŒåŸ å…¥å£æ ‡è®°ï¼ˆğŸŒŸï¼‰

        // åŠ è½½é«˜å¾·API
        function loadAMapScript() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = `https://webapi.amap.com/maps?v=2.0&key=${AMAP_KEY}&callback=initAMap`;
                script.type = 'text/javascript';
                document.head.appendChild(script);
                window.initAMap = resolve;
                script.onerror = reject;
            });
        }

        // è·å–ç”¨æˆ·åœ°ç†ä½ç½®
        function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error("ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®å®šä½"));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        resolve({ lng, lat });
                    },
                    (error) => {
                        let errorMsg = "";
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMsg = "ä½ æ‹’ç»äº†ä½ç½®æƒé™è¯·æ±‚";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMsg = "ä½ç½®ä¿¡æ¯ä¸å¯ç”¨";
                                break;
                            case error.TIMEOUT:
                                errorMsg = "è·å–ä½ç½®è¶…æ—¶";
                                break;
                            default:
                                errorMsg = "å®šä½å¤±è´¥ï¼Œè¯·é‡è¯•";
                        }
                        reject(new Error(errorMsg));
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        // åˆ›å»ºå°ç†Šæ ‡è®°ï¼ˆä½¿ç”¨ bear-marker ç±»ï¼‰
        function createBearMarker(position, mapInstance) {
            const marker = new AMap.Marker({
                position: position,
                title: "ä½ çš„å½“å‰ä½ç½®",
                map: mapInstance,
                content: '<div class="bear-marker">ğŸ»</div>',
                anchor: "bottom-center",
                cursor: 'pointer'
            });

            const infoWindow = new AMap.InfoWindow({
                content: "<div style='padding: 10px; font-size: 16px;'>ğŸ» è¿™æ˜¯ä½ çš„å½“å‰ä½ç½®</div>",
                offset: new AMap.Pixel(0, -38)
            });

            // ç‚¹å‡»å°ç†Šæ—¶ï¼Œæ›´æ–°ä¸‹æ–¹çš„ä¿¡æ¯æ¡†ï¼ˆå›¾æ–‡æ··æ’ï¼‰å¹¶æ‰“å¼€ä¿¡æ¯çª—å£
            marker.on("click", () => {
                // æ›´æ–°ä¸‹æ–¹ä¿¡æ¯æ¡†ï¼Œæ˜¾ç¤ºå›¾ç‰‡ + æ–‡å­—
                const infoBox = document.getElementById('clickInfo');
                const lng = position[0].toFixed(6);
                const lat = position[1].toFixed(6);
                infoBox.innerHTML = `
                    <span class="label">ğŸ» å°ç†Šä½ç½®è¯¦æƒ…</span>
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <img src="https://img.icons8.com/color/96/000000/bear.png" width="48" height="48" alt="å°ç†Šå›¾æ ‡">
                        <div>
                            <strong style="font-size: 18px;">ä½ çš„å½“å‰ä½ç½®</strong><br>
                            ç»åº¦ï¼š${lng}<br>
                            çº¬åº¦ï¼š${lat}
                        </div>
                    </div>
                    <p style="margin-top: 12px; color: #4a6a8a;">â±ï¸ ç‚¹å‡»æ—¶é—´ï¼š${new Date().toLocaleTimeString()}</p>
                `;

                // æ‰“å¼€åŸæœ‰çš„ä¿¡æ¯çª—å£
                infoWindow.open(mapInstance, marker.getPosition());
            });

            return marker;
        }

        // åº”ç”¨æŒ‡å®šç´¢å¼•çš„æ ·å¼ï¼ˆä½¿ç”¨å®˜æ–¹setMapStyleï¼‰ï¼Œå¹¶ä¿å­˜åˆ°localStorage
        function applyStyle(index) {
            if (!map) return;
            const style = STYLES[index];
            // ç›´æ¥è°ƒç”¨setMapStyleåˆ‡æ¢å†…ç½®æ ·å¼ï¼ˆå®˜æ–¹æ ¼å¼ï¼‰
            map.setMapStyle(style.id);
            // æ›´æ–°æ˜¾ç¤ºåç§°
            document.getElementById('currentStyleName').innerText = style.name;
            // ä¿å­˜å½“å‰ç´¢å¼•åˆ°localStorage
            localStorage.setItem(STYLE_STORAGE_KEY, index);
            // æ›´æ–°å…¨å±€ç´¢å¼•
            currentStyleIndex = index;
        }

        // åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªæ ·å¼
        function prevStyle() {
            const newIndex = (currentStyleIndex - 1 + STYLES.length) % STYLES.length;
            applyStyle(newIndex);
        }

        // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ ·å¼
        function nextStyle() {
            const newIndex = (currentStyleIndex + 1) % STYLES.length;
            applyStyle(newIndex);
        }

        // åˆå§‹åŒ–åœ°å›¾
        async function initMap() {
            try {
                await loadAMapScript();

                // ä¸­å›½ä¸­éƒ¨ä¸ºä¸­å¿ƒï¼ˆç¼©æ”¾5å¯çœ‹åˆ°å¤§éƒ¨åˆ†ç‰ˆå›¾ï¼‰
                const chinaCenter = [104.0, 35.0];
                const zoomLevel = 5;

                // åˆ›å»ºåœ°å›¾å®ä¾‹
                map = new AMap.Map("mapContainer", {
                    zoom: zoomLevel,
                    center: chinaCenter,
                    viewMode: '2D'
                });

                // ä»localStorageè¯»å–ä¸Šæ¬¡ä¿å­˜çš„æ ·å¼ç´¢å¼•ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä¸º0
                const savedStyleIndex = localStorage.getItem(STYLE_STORAGE_KEY);
                if (savedStyleIndex !== null && !isNaN(parseInt(savedStyleIndex))) {
                    currentStyleIndex = parseInt(savedStyleIndex);
                    // ç¡®ä¿ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
                    if (currentStyleIndex < 0 || currentStyleIndex >= STYLES.length) {
                        currentStyleIndex = 0;
                    }
                } else {
                    currentStyleIndex = 0;
                }

                // åº”ç”¨æ ·å¼ï¼ˆä¼šæ›´æ–°æ˜¾ç¤ºåç§°å¹¶ä¿å­˜åˆ°localStorageï¼‰
                applyStyle(currentStyleIndex);

                // ----- åˆ›å»ºèšŒåŸ å…¥å£æ ‡è®°ï¼ˆğŸŒŸï¼‰ä½¿ç”¨ star-marker ç±» -----
                const bengbuPos = [117.38, 32.92]; // èšŒåŸ å¸‚åŒºåæ ‡
                bengbuEntryMarker = new AMap.Marker({
                    position: bengbuPos,
                    title: "ç‚¹å‡»æŸ¥çœ‹èšŒåŸ ",
                    map: map,
                    content: '<div class="star-marker">ğŸŒŸ</div>',
                    anchor: "bottom-center",
                    cursor: 'pointer'
                });

                // æ ¹æ®å½“å‰ç¼©æ”¾çº§åˆ«è®¾ç½®åˆå§‹å¯è§æ€§ï¼ˆå°ç¼©æ”¾æ˜¾ç¤ºï¼Œå¤§ç¼©æ”¾éšè—ï¼‰
                const initialZoom = map.getZoom();
                if (initialZoom >= 7) {
                    bengbuEntryMarker.hide();
                }

                // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼šæ”¾å¤§åœ°å›¾è‡³èšŒåŸ 
                bengbuEntryMarker.on("click", () => {
                    map.setCenter(bengbuPos);
                    map.setZoom(12);
                });

                // ç›‘å¬åœ°å›¾ç¼©æ”¾çº§åˆ«å˜åŒ–ï¼Œæ§åˆ¶èšŒåŸ å…¥å£æ ‡è®°çš„æ˜¾ç¤º/éšè—ï¼ˆé˜ˆå€¼7ï¼‰
                map.on('zoomchange', () => {
                    const currentZoom = map.getZoom();
                    if (currentZoom < 7) {
                        bengbuEntryMarker.show();
                    } else {
                        bengbuEntryMarker.hide();
                    }
                });

                // ----- å°è¯•ä»localStorageè¯»å–ä¸Šæ¬¡å®šä½ä½ç½®ï¼ˆä»…æ˜¾ç¤ºå°ç†Šï¼Œä¸ç§»åœ°å›¾ä¸­å¿ƒï¼‰-----
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    try {
                        const pos = JSON.parse(stored);
                        if (Array.isArray(pos) && pos.length === 2 && 
                            typeof pos[0] === 'number' && typeof pos[1] === 'number') {
                            
                            currentUserMarker = createBearMarker(pos, map);
                            console.log("ä»ç¼“å­˜åŠ è½½ä¸Šæ¬¡ä½ç½®ï¼Œåœ°å›¾ä¸­å¿ƒä¿æŒä¸­å›½ä¸­éƒ¨:", pos);
                        } else {
                            console.warn("localStorageä¸­çš„ä½ç½®æ ¼å¼æ— æ•ˆ");
                        }
                    } catch (e) {
                        console.warn("è§£æå­˜å‚¨ä½ç½®å¤±è´¥", e);
                    }
                }

                console.log("åœ°å›¾åˆå§‹åŒ–å®Œæˆï¼Œä¸­å¿ƒ:", chinaCenter, "ç¼©æ”¾:", zoomLevel);
            } catch (error) {
                alert("åœ°å›¾åŠ è½½å¤±è´¥ï¼š" + error.message);
                console.error("åœ°å›¾åŠ è½½å¤±è´¥ï¼š", error);
            }
        }

        // å®šä½å¹¶æ›´æ–°å°ç†Šæ ‡è®°
        async function locateAndUpdateBear() {
            if (!map) {
                alert("åœ°å›¾å°šæœªåˆå§‹åŒ–å®Œæˆï¼Œè¯·ç¨åé‡è¯•");
                return;
            }

            const btn = document.getElementById('locateBtn');
            const originalText = btn.innerText;
            btn.innerText = 'å®šä½ä¸­...';
            btn.disabled = true;

            try {
                const { lng, lat } = await getUserLocation();
                const newPos = [lng, lat];

                if (currentUserMarker) {
                    currentUserMarker.setMap(null);
                    currentUserMarker = null;
                }

                currentUserMarker = createBearMarker(newPos, map);
                map.setCenter(newPos);
                map.setZoom(15);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(newPos));

                console.log("å®šä½æˆåŠŸï¼Œä½ç½®å·²æ›´æ–°å¹¶ä¿å­˜ï¼Œç¼©æ”¾è°ƒæ•´ä¸º15", newPos);
            } catch (error) {
                alert("å®šä½å¤±è´¥ï¼š" + error.message);
                console.error("å®šä½å¤±è´¥ï¼š", error);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // é‡ç½®è§†å›¾åˆ°åˆå§‹çŠ¶æ€
        function resetToInitial() {
            if (!map) return;
            const chinaCenter = [104.0, 35.0];
            map.setCenter(chinaCenter);
            map.setZoom(5);
        }

        // ç¼©æ”¾æ§åˆ¶
        function zoomIn() {
            if (!map) return;
            map.setZoom(map.getZoom() + 1);
        }
        function zoomOut() {
            if (!map) return;
            map.setZoom(map.getZoom() - 1);
        }

        // é¡µé¢åŠ è½½ååˆå§‹åŒ–åœ°å›¾å¹¶ç»‘å®šäº‹ä»¶
        window.onload = () => {
            initMap();

            document.getElementById('locateBtn').addEventListener('click', locateAndUpdateBear);
            document.getElementById('resetBtn').addEventListener('click', resetToInitial);
            document.getElementById('zoomInBtn').addEventListener('click', zoomIn);
            document.getElementById('zoomOutBtn').addEventListener('click', zoomOut);

            // æ ·å¼åˆ‡æ¢ç®­å¤´
            document.getElementById('stylePrevBtn').addEventListener('click', prevStyle);
            document.getElementById('styleNextBtn').addEventListener('click', nextStyle);
        };
    </script>
</body>
</html>