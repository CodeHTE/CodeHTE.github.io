<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¯ç¼–è¾‘å¤§å­¦è¯¾ç¨‹è¡¨ Â· è¯¾ç¨‹ç±»å‹é¢œè‰²åŒºåˆ†</title>
<style>
  *{
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family:"Microsoft YaHei",sans-serif;
  }
  body{
    background:#f7f8fa;
    padding:20px;
  }
  .wrap{
    max-width:1400px;
    margin:0 auto;
    background:#fff;
    border-radius:10px;
    box-shadow:0 2px 12px rgba(0,0,0,0.08);
    overflow:hidden;
  }
  .title{
    text-align:center;
    padding:20px;
    font-size:24px;
    font-weight:bold;
    color:#333;
    background:#fafafa;
    border-bottom:1px solid #eee;
  }
  table{
    width:100%;
    border-collapse:collapse;
    table-layout: fixed;
  }
  th,td{
    border:1px solid #e5e7eb;
    text-align:center;
    padding:8px 4px;
    position:relative;
  }
  th{
    background:#415fff;
    color:#fff;
    font-weight:normal;
  }
  th:first-child, td.time-block {
    width: 50px;
  }
  th:nth-child(2), td.lesson-index {
    width: 40px;
  }
  th:nth-child(n+3), td.course-cell {
    width: 120px;
  }
  .time-block{
    background:#f8f9fa;
    font-weight:bold;
    font-size:16px;
  }
  .morning{ background:#e6f7ff; }
  .afternoon{ background:#f6ffed; }
  .evening{ background:#fff7e6; }
  
  .course-cell{
    /*min-height:70px;*/
    height: 70px !important;
    cursor:default;
    transition:background-color 0.2s;
    vertical-align:top;
    padding:4px;
  }
  .course-cell.editable{
    cursor:pointer;
  }
  .course-cell:hover{
    background-color:#f0f7ff;
  }
  .course-cell.selected {
    background-color: #b8d4ff !important;
    outline: 2px solid #415fff;
    outline-offset: -2px;
  }
  .course-cell.merge-hover {
    background-color: #c0f0c0 !important;
    outline: 2px solid #2e7d32;
    outline-offset: -2px;
  }
  /* æ–°å¢ï¼šå¤åˆ¶é«˜äº®æ ·å¼ */
  .course-cell.copy-hover {
    background-color: #fff3cd !important;
    outline: 2px solid #fd7e14;
    outline-offset: -2px;
  }
  /* æ–°å¢ï¼šéšè—è¢«åˆå¹¶çš„å•å…ƒæ ¼ */
  .course-cell.merged {
    display: none;
  }
  
  /* è¯¾ç¨‹ç±»å‹é¢œè‰²æ ·å¼ */
  .course-content{
    border-radius:6px;
    padding:6px 4px;
    display:flex;
    flex-direction:column;
    gap:4px;
    text-align:left;
    font-size:13px;
    box-shadow:0 1px 3px rgba(0,0,0,0.05);
    height:100%;
    max-height: 280px;
    overflow-y: auto;
    word-break: break-word;
  }
  /* æ— ç±»å‹ */
  .course-content.type-none { background: #dbeafe; }
  .course-content.type-none .course-name { color: #1e3a8a; }
  .course-content.type-none .course-location-teacher { border-top-color: #a5c0fa; }
  
  /* ä¸“å¿…è¯¾ */
  .course-content.type-required-major { background: #ffe485; }
  .course-content.type-required-major .course-name { color: #78350f; }
  .course-content.type-required-major .course-location-teacher { border-top-color: #fbbf24; }
  
  /* ä¸“é€‰è¯¾ */
  .course-content.type-elective-major { background: #bae6fd; }
  .course-content.type-elective-major .course-name { color: #0c4a6e; }
  .course-content.type-elective-major .course-location-teacher { border-top-color: #38bdf8; }
  
  /* å…¬å¿…è¯¾ */
  .course-content.type-required-public { background: #fed7aa; }
  .course-content.type-required-public .course-name { color: #9a3412; }
  .course-content.type-required-public .course-location-teacher { border-top-color: #fb923c; }
  
  /* å…¬é€‰è¯¾ */
  .course-content.type-elective-public { background: #bfdbfe; }
  .course-content.type-elective-public .course-name { color: #1e40af; }
  .course-content.type-elective-public .course-location-teacher { border-top-color: #60a5fa; }
  
  /* ä½“è‚²è¯¾ */
  .course-content.type-pe { background: #bbf7d0; }
  .course-content.type-pe .course-name { color: #14532d; }
  .course-content.type-pe .course-location-teacher { border-top-color: #4ade80; }
  
  /* é¢å¤– */
  .course-content.type-extra { background: #fbcfe8; }
  .course-content.type-extra .course-name { color: #831843; }
  .course-content.type-extra .course-location-teacher { border-top-color: #f472b6; }
  
  .course-content::-webkit-scrollbar {
    width: 4px;
  }
  .course-content::-webkit-scrollbar-thumb {
    background: #a0b8cc;
    border-radius: 4px;
  }
  .course-name{
    font-weight:700;
    font-size:14px;
    line-height:1.3;
    word-break:break-word;
  }
  .course-type-tag{
    font-size:10px;
    padding:1px 4px;
    border-radius:3px;
    margin-left:4px;
    color:white;
    vertical-align:middle;
  }
  /* ç±»å‹æ ‡ç­¾é¢œè‰² */
  .tag-none { display: none; }
  .tag-required-major { background: #78350f; }
  .tag-elective-major { background: #0c4a6e; }
  .tag-required-public { background: #9a3412; }
  .tag-elective-public { background: #1e40af; }
  .tag-pe { background: #14532d; }
  .tag-extra { background: #831843; }
  
  .course-location-teacher{
    display:flex;
    align-items:center;
    gap:4px;
    color:#2c3e50;
    font-size:12px;
    line-height:1.4;
    word-break:break-word;
    border-top:1px dashed #a5c0fa;
    padding-top:4px;
  }
  .course-location-teacher::before{
    content:"ğŸ“";
    margin-right:2px;
    opacity:0.8;
  }
  .empty{
    background:#f9f9fc;
  }
  .empty .course-content{
    display:none;
  }

  .table-footer{
    display:flex;
    justify-content:center;
    gap:20px;
    padding:20px;
    background:#fafafa;
    border-top:1px solid #e5e7eb;
    flex-wrap: wrap;
  }
  .action-btn{
    padding:10px 30px;
    border:none;
    border-radius:40px;
    font-size:16px;
    font-weight:500;
    cursor:pointer;
    transition:all 0.2s;
    box-shadow:0 2px 6px rgba(0,0,0,0.05);
  }
  .edit-btn{
    background:#415fff;
    color:white;
  }
  .edit-btn:hover{
    background:#2e4ad6;
    transform:translateY(-2px);
    box-shadow:0 6px 12px rgba(65,95,255,0.3);
  }
  .save-all{
    background:#415fff;
    color:white;
  }
  .save-all:hover{
    background:#2e4ad6;
    transform:translateY(-2px);
    box-shadow:0 6px 12px rgba(65,95,255,0.3);
  }
  .clear-all{
    background:#ffffff;
    color:#4b5563;
    border:1px solid #d1d5db;
  }
  .clear-all:hover{
    background:#f3f4f6;
    transform:translateY(-2px);
    box-shadow:0 6px 12px rgba(0,0,0,0.1);
  }
  .exit-edit{
    background:#f97316;
    color:white;
  }
  .exit-edit:hover{
    background:#ea580c;
    transform:translateY(-2px);
    box-shadow:0 6px 12px rgba(249,115,22,0.3);
  }
  .delete-btn, .split-btn{
    background:#ffffff;
    color:#4b5563;
    border:1px solid #d1d5db;
  }
  .delete-btn:not(:disabled):hover {
    background:#fee2e2;
    border-color:#f87171;
    color:#b91c1c;
    transform:translateY(-2px);
    box-shadow:0 6px 12px rgba(239,68,68,0.2);
  }
  .split-btn:not(:disabled):hover {
    background:#e0f2e0;
    border-color:#2e7d32;
    color:#1b5e20;
    transform:translateY(-2px);
    box-shadow:0 6px 12px rgba(46,125,50,0.2);
  }
  .delete-btn:disabled, .split-btn:disabled {
    opacity:0.4;
    cursor:not-allowed;
    transform:none;
    box-shadow:none;
  }

  .float-edit-panel {
    position: fixed;
    background: white;
    border: 2px solid #415fff;
    border-radius: 10px;
    padding: 16px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    z-index: 1000;
    width: 260px;
    display: none;
    flex-direction: column;
    gap: 12px;
  }
  .float-edit-panel .field {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .float-edit-panel label {
    font-size: 12px;
    color: #4b5563;
    font-weight: 500;
  }
  .float-edit-panel input,
  .float-edit-panel select {
    padding: 6px 8px;
    border: 1px solid #cbd5e1;
    border-radius: 4px;
    font-size: 13px;
    outline: none;
  }
  .float-edit-panel input:focus,
  .float-edit-panel select:focus {
    border-color: #415fff;
    box-shadow: 0 0 0 2px rgba(65,95,255,0.2);
  }
  .float-edit-panel .panel-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 8px;
  }
  .float-edit-panel .panel-save,
  .float-edit-panel .panel-cancel {
    padding: 5px 14px;
    border: none;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
  }
  .float-edit-panel .panel-save {
    background: #415fff;
    color: white;
  }
  .float-edit-panel .panel-cancel {
    background: #f1f5f9;
    color: #334155;
  }

  /* æ“ä½œé€‰æ‹©å¼¹çª—æ ·å¼ */
  .action-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    z-index: 2000;
    display: none;
    flex-direction: column;
    gap: 16px;
    min-width: 280px;
  }
  .action-modal .modal-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    text-align: center;
  }
  .action-modal .modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
  }
  .action-modal .modal-btn {
    padding: 8px 20px;
    border: none;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }
  .modal-btn.merge {
    background: #2e7d32;
    color: white;
  }
  .modal-btn.merge:hover {
    background: #1b5e20;
    transform: translateY(-2px);
  }
  .modal-btn.copy {
    background: #415fff;
    color: white;
  }
  .modal-btn.copy:hover {
    background: #2e4ad6;
    transform: translateY(-2px);
  }
  .modal-btn.cancel {
    background: #f1f5f9;
    color: #4b5563;
    border: 1px solid #d1d5db;
  }
  .modal-btn.cancel:hover {
    background: #e2e8f0;
    transform: translateY(-2px);
  }

  /* å¤åˆ¶ç¡®è®¤å¼¹çª—æ ·å¼ */
  .confirm-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    z-index: 2000;
    display: none;
    flex-direction: column;
    gap: 16px;
    min-width: 280px;
  }
  .confirm-modal .modal-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    text-align: center;
  }
  .confirm-modal .modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
  }

  /* é®ç½©å±‚æ ·å¼ */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1999;
    display: none;
    /* ç¦æ­¢é®ç½©å±‚ç‚¹å‡»äº‹ä»¶ç©¿é€ */
    pointer-events: none;
  }
  /* å¼¹çª—æ˜¾ç¤ºæ—¶é®ç½©å±‚å…è®¸ç‚¹å‡»ï¼ˆä½†ä»…ç”¨äºè§†è§‰ï¼Œä¸å¤„ç†å…³é—­ï¼‰ */
  .modal-overlay.show {
    pointer-events: auto;
  }
  #courseTable tbody tr {
  height: 70px; /* å¯æ ¹æ®éœ€è¦è°ƒæ•´ï¼Œå»ºè®®ä¸åŸæ¥å•å…ƒæ ¼é«˜åº¦ç›¸è¿‘ */
  }

</style>
</head>
<body>
<div class="wrap">
  <div class="title">å¯ç¼–è¾‘è¯¾ç¨‹è¡¨ Â· è¯¾ç¨‹ç±»å‹é¢œè‰²åŒºåˆ†</div>
  <table id="courseTable">
    <thead>
      <tr>
        <th>æ—¶æ®µ</th>
        <th>èŠ‚æ¬¡</th>
        <th>å‘¨ä¸€</th>
        <th>å‘¨äºŒ</th>
        <th>å‘¨ä¸‰</th>
        <th>å‘¨å››</th>
        <th>å‘¨äº”</th>
        <th>å‘¨å…­</th>
        <th>å‘¨æ—¥</th>
      </tr>
    </thead>
    <tbody>
      <!-- ä¸Šåˆ 1-4 èŠ‚ -->
      <tr class="morning">
        <td rowspan="4" class="time-block">ä¸Šåˆ</td>
        <td>1</td>
        <td class="course-cell" data-name="é«˜ç­‰æ•°å­¦" data-location="ä¸€æ•™101" data-teacher="å¼ è€å¸ˆ" data-type="required-major">
          <div class="course-content type-required-major"><div class="course-name">é«˜ç­‰æ•°å­¦<span class="course-type-tag tag-required-major">ä¸“å¿…è¯¾</span></div><div class="course-location-teacher">ä¸€æ•™101 ä¸¨ å¼ è€å¸ˆ</div></div>
        </td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
      </tr>
      <tr class="morning">
        <td>2</td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
      </tr>
      <tr class="morning">
        <td>3</td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
      </tr>
      <tr class="morning">
        <td>4</td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
      </tr>

      <!-- ä¸‹åˆ 5-8 èŠ‚ -->
      <tr class="afternoon">
        <td rowspan="4" class="time-block">ä¸‹åˆ</td>
        <td>5</td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
      </tr>
      <tr class="afternoon">
        <td>6</td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
      </tr>
      <tr class="afternoon">
        <td>7</td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
      </tr>
      <tr class="afternoon">
        <td>8</td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
      </tr>

      <!-- æ™šä¸Š 9-12 èŠ‚ -->
      <tr class="evening">
        <td rowspan="4" class="time-block">æ™šä¸Š</td>
        <td>9</td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
      </tr>
      <tr class="evening">
        <td>10</td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
      </tr>
      <tr class="evening">
        <td>11</td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
      </tr>
      <tr class="evening">
        <td>12</td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
        <td class="course-cell empty" data-name="" data-location="" data-teacher="" data-type="none"></td>
      </tr>
    </tbody>
  </table>

  <div class="table-footer" id="footerButtons">
    <button class="action-btn edit-btn" id="editModeBtn">âœï¸ ç¼–è¾‘</button>
  </div>
</div>

<!-- è¯¾ç¨‹ç¼–è¾‘é¢æ¿ï¼ˆæ–°å¢ç±»å‹é€‰æ‹©å™¨ï¼‰ -->
<div class="float-edit-panel" id="floatEditPanel">
  <div class="field">
    <label>ğŸ“˜ è¯¾ç¨‹åç§°</label>
    <input type="text" id="editName" placeholder="ä¾‹å¦‚ï¼šé«˜ç­‰æ•°å­¦">
  </div>
  <div class="field">
    <label>ğŸ“š è¯¾ç¨‹ç±»å‹</label>
    <select id="editType">
      <option value="none">æ— </option>
      <option value="required-major">ä¸“å¿…è¯¾</option>
      <option value="elective-major">ä¸“é€‰è¯¾</option>
      <option value="required-public">å…¬å¿…è¯¾</option>
      <option value="elective-public">å…¬é€‰è¯¾</option>
      <option value="pe">ä½“è‚²è¯¾</option>
      <option value="extra">é¢å¤–</option>
    </select>
  </div>
  <div class="field">
    <label>ğŸ“ åœ°ç‚¹</label>
    <input type="text" id="editLocation" placeholder="ä¾‹å¦‚ï¼šä¸€æ•™101">
  </div>
  <div class="field">
    <label>ğŸ‘¤ æ•™å¸ˆ</label>
    <input type="text" id="editTeacher" placeholder="ä¾‹å¦‚ï¼šå¼ è€å¸ˆ">
  </div>
  <div class="panel-buttons">
    <button class="panel-save" id="panelSave">ä¿å­˜</button>
    <button class="panel-cancel" id="panelCancel">å–æ¶ˆ</button>
  </div>
</div>

<!-- æ“ä½œé€‰æ‹©å¼¹çª—ï¼ˆåˆå¹¶/å¤åˆ¶ï¼‰ -->
<div class="action-modal" id="actionModal">
  <div class="modal-title">é€‰æ‹©ä½ è¦è¿›è¡Œçš„æ“ä½œ</div>
  <div class="modal-buttons">
    <button class="modal-btn merge" id="modalMergeBtn">åˆå¹¶</button>
    <button class="modal-btn copy" id="modalCopyBtn">å¤åˆ¶</button>
    <button class="modal-btn cancel" id="modalCancelBtn">å–æ¶ˆ</button>
  </div>
</div>

<!-- å¤åˆ¶ç¡®è®¤å¼¹çª— -->
<div class="confirm-modal" id="confirmModal">
  <div class="modal-title">ç¡®å®šè¦å¤åˆ¶è¯¾ç¨‹ä¿¡æ¯å—ï¼Ÿ</div>
  <div class="modal-buttons">
    <button class="modal-btn copy" id="confirmCopyBtn">ç¡®å®š</button>
    <button class="modal-btn cancel" id="confirmCancelBtn">å–æ¶ˆ</button>
  </div>
</div>

<!-- é®ç½©å±‚ -->
<div class="modal-overlay" id="modalOverlay"></div>

<script>
(function() {
  // ---------- è¯¾ç¨‹ç±»å‹é…ç½®ï¼ˆå¯è‡ªå®šä¹‰ï¼‰ ----------
  const courseTypeConfig = {
    'none': {
      name: 'æ— ',
      bgColor: '#dbeafe',
      textColor: '#1e3a8a',
      borderColor: '#a5c0fa',
      tagClass: 'tag-none'
    },
    'required-major': {
      name: 'ä¸“å¿…è¯¾',
      bgColor: '#ffe485',
      textColor: '#78350f',
      borderColor: '#fbbf24',
      tagClass: 'tag-required-major'
    },
    'elective-major': {
      name: 'ä¸“é€‰è¯¾',
      bgColor: '#bae6fd',
      textColor: '#0c4a6e',
      borderColor: '#38bdf8',
      tagClass: 'tag-elective-major'
    },
    'required-public': {
      name: 'å…¬å¿…è¯¾',
      bgColor: '#fed7aa',
      textColor: '#9a3412',
      borderColor: '#fb923c',
      tagClass: 'tag-required-public'
    },
    'elective-public': {
      name: 'å…¬é€‰è¯¾',
      bgColor: '#bfdbfe',
      textColor: '#1e40af',
      borderColor: '#60a5fa',
      tagClass: 'tag-elective-public'
    },
    'pe': {
      name: 'ä½“è‚²è¯¾',
      bgColor: '#bbf7d0',
      textColor: '#14532d',
      borderColor: '#4ade80',
      tagClass: 'tag-pe'
    },
    'extra': {
      name: 'é¢å¤–',
      bgColor: '#fbcfe8',
      textColor: '#831843',
      borderColor: '#f472b6',
      tagClass: 'tag-extra'
    }
  };

  // ---------- é€šç”¨å·¥å…·å‡½æ•° ----------
  function updateCellDisplay(cell, name, location, teacher, type) {
    // ç¡®ä¿typeæœ‰é»˜è®¤å€¼
    type = type || cell.dataset.type || 'none';
    // éªŒè¯ç±»å‹æœ‰æ•ˆæ€§
    if (!courseTypeConfig[type]) type = 'none';
    
    const oldContent = cell.querySelector('.course-content');
    if (oldContent) oldContent.remove();

    if (name) {
      cell.classList.remove('empty');
      const contentDiv = document.createElement('div');
      // è®¾ç½®ç±»å‹æ ·å¼ç±»
      contentDiv.className = `course-content type-${type}`;

      let locationTeacher = '';
      if (location && teacher) {
        locationTeacher = `${escapeHtml(location)} ä¸¨ ${escapeHtml(teacher)}`;
      } else if (location) {
        locationTeacher = `${escapeHtml(location)} ä¸¨ â€”`;
      } else if (teacher) {
        locationTeacher = `â€” ä¸¨ ${escapeHtml(teacher)}`;
      } else {
        locationTeacher = 'â€” ä¸¨ â€”';
      }

      // æ„å»ºè¯¾ç¨‹åç§°ï¼ˆåŒ…å«ç±»å‹æ ‡ç­¾ï¼‰
      let courseNameHtml = escapeHtml(name);
      if (type !== 'none') {
        courseNameHtml += `<span class="course-type-tag ${courseTypeConfig[type].tagClass}">${courseTypeConfig[type].name}</span>`;
      }

      contentDiv.innerHTML = `
        <div class="course-name" style="color: ${courseTypeConfig[type].textColor}">${courseNameHtml}</div>
        <div class="course-location-teacher" style="border-top-color: ${courseTypeConfig[type].borderColor}">${locationTeacher}</div>
      `;
      cell.appendChild(contentDiv);
    } else {
      cell.classList.add('empty');
    }
    
    // æ›´æ–°å•å…ƒæ ¼çš„typeæ•°æ®å±æ€§
    cell.dataset.type = type;
  }

  function escapeHtml(unsafe) {
    if (!unsafe) return unsafe;
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // åˆå§‹åŒ–å•å…ƒæ ¼å…ƒæ•°æ®
  function initMetadata() {
    const cells = document.querySelectorAll('.course-cell');
    cells.forEach(cell => {
      const tr = cell.closest('tr');
      if (!tr) return;
      const cellsInRow = tr.cells;
      let idx = -1;
      for (let i = 0; i < cellsInRow.length; i++) {
        if (cellsInRow[i] === cell) {
          idx = i;
          break;
        }
      }
      if (idx === -1) return;

      let baseOffset = 0;
      if (cellsInRow.length > 0 && cellsInRow[0].rowSpan > 1) {
        baseOffset = 2; // æ—¶æ®µ + èŠ‚æ¬¡
      } else {
        baseOffset = 1; // åªæœ‰èŠ‚æ¬¡
      }
      const weekdayIndex = idx - baseOffset; // 0:å‘¨ä¸€ ... 6:å‘¨æ—¥
      if (weekdayIndex >= 0 && weekdayIndex < 7) {
        const weekdays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
        cell.dataset.weekday = weekdays[weekdayIndex];
      }
      if (tr.classList.contains('morning')) {
        cell.dataset.session = 'ä¸Šåˆ';
      } else if (tr.classList.contains('afternoon')) {
        cell.dataset.session = 'ä¸‹åˆ';
      } else if (tr.classList.contains('evening')) {
        cell.dataset.session = 'æ™šä¸Š';
      }
      const lessonTd = cellsInRow[baseOffset - 1];
      if (lessonTd) {
        cell.dataset.lesson = lessonTd.textContent.trim();
      }
      if (!cell.dataset.mergeSize) {
        cell.dataset.mergeSize = '1';
      }
      if (!cell.dataset.mergedBy) {
        cell.dataset.mergedBy = '';
      }
      // åˆå§‹åŒ–è¯¾ç¨‹ç±»å‹
      if (!cell.dataset.type) {
        cell.dataset.type = 'none';
      }
    });
  }

  // ---------- æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ----------
  // å¤åˆ¶è¯¾ç¨‹ä¿¡æ¯ï¼ˆåŒ…å«ç±»å‹ï¼‰
  function copyCourseInfo(sourceCell, targetCell) {
    if (!sourceCell || !targetCell) return;
    targetCell.dataset.name = sourceCell.dataset.name || '';
    targetCell.dataset.location = sourceCell.dataset.location || '';
    targetCell.dataset.teacher = sourceCell.dataset.teacher || '';
    targetCell.dataset.type = sourceCell.dataset.type || 'none'; // å¤åˆ¶ç±»å‹
    updateCellDisplay(targetCell, targetCell.dataset.name, targetCell.dataset.location, targetCell.dataset.teacher, targetCell.dataset.type);
  }

  // åˆ¤æ–­æ˜¯å¦å¯åˆå¹¶
  function canMerge(cellA, cellB) {
    if (!cellA || !cellB || cellA === cellB) return false;
    if (cellA.dataset.weekday !== cellB.dataset.weekday) return false;
    if (cellA.dataset.session !== cellB.dataset.session) return false;
    
    const lessonA = parseInt(cellA.dataset.lesson);
    const sizeA = parseInt(cellA.dataset.mergeSize);
    const lessonB = parseInt(cellB.dataset.lesson);
    const sizeB = parseInt(cellB.dataset.mergeSize);
    
    return (lessonA + sizeA === lessonB) || (lessonB + sizeB === lessonA);
  }

  // åˆå¹¶å•å…ƒæ ¼ï¼ˆä¿ç•™ç±»å‹ï¼‰
  function mergeCells(selected, target) {
    if (!canMerge(selected, target)) return;
    
    const lessonSel = parseInt(selected.dataset.lesson);
    const lessonTar = parseInt(target.dataset.lesson);
    let top, bottom;
    
    if (lessonSel < lessonTar) {
      top = selected;
      bottom = target;
    } else {
      top = target;
      bottom = selected;
    }
    
    // å¤åˆ¶å†…å®¹ï¼ˆåŒ…å«ç±»å‹ï¼‰åˆ°é¡¶éƒ¨å•å…ƒæ ¼
    if (selected === bottom) {
      top.dataset.name = selected.dataset.name;
      top.dataset.location = selected.dataset.location;
      top.dataset.teacher = selected.dataset.teacher;
      top.dataset.type = selected.dataset.type; // å¤åˆ¶ç±»å‹
      updateCellDisplay(top, top.dataset.name, top.dataset.location, top.dataset.teacher, top.dataset.type);
    }
    
    // æ›´æ–°åˆå¹¶å°ºå¯¸
    const newSize = parseInt(top.dataset.mergeSize) + parseInt(bottom.dataset.mergeSize);
    top.rowSpan = newSize;
    top.dataset.mergeSize = newSize;
    
    // æ ‡è®°è¢«åˆå¹¶çš„å•å…ƒæ ¼
    bottom.dataset.mergedBy = top.dataset.lesson + '-' + top.dataset.weekday;
    bottom.classList.add('merged');
    
    // æ›´æ–°é€‰ä¸­çŠ¶æ€
    clearSelected();
    top.classList.add('selected');
    selectedCell = top;
    updateButtonStates();
  }

  // æ‹†åˆ†å•å…ƒæ ¼
  function splitCell(cell) {
    const mergeSize = parseInt(cell.dataset.mergeSize);
    if (mergeSize <= 1) return;

    const lesson = parseInt(cell.dataset.lesson);
    const weekday = cell.dataset.weekday;
    const mergeKey = lesson + '-' + weekday;

    // æ¢å¤å½“å‰å•å…ƒæ ¼ä¸ºå•è¡Œ
    cell.rowSpan = 1;
    cell.dataset.mergeSize = '1';

    // æ˜¾ç¤ºå¹¶é‡ç½®è¢«åˆå¹¶çš„å•å…ƒæ ¼
    const mergedCells = document.querySelectorAll(`.course-cell[data-merged-by="${mergeKey}"]`);
    mergedCells.forEach(mergedCell => {
      mergedCell.dataset.mergedBy = '';
      mergedCell.classList.remove('merged');
      mergedCell.dataset.mergeSize = '1';
      mergedCell.dataset.name = '';
      mergedCell.dataset.location = '';
      mergedCell.dataset.teacher = '';
      mergedCell.dataset.type = 'none'; // é‡ç½®ç±»å‹ä¸ºæ— 
      updateCellDisplay(mergedCell, '', '', '', 'none');
    });

    initMetadata();
    updateButtonStates();
  }

  // ---------- å¼¹çª—æ§åˆ¶å‡½æ•° ----------
  // æ˜¾ç¤ºæ“ä½œå¼¹çª—ï¼ˆåˆå¹¶/å¤åˆ¶ï¼‰
  function showActionModal() {
    const overlay = document.getElementById('modalOverlay');
    overlay.style.display = 'block';
    overlay.classList.add('show');
    document.getElementById('actionModal').style.display = 'flex';
    document.getElementById('confirmModal').style.display = 'none';
    document.body.style.overflow = 'hidden';
  }

  // æ˜¾ç¤ºå¤åˆ¶ç¡®è®¤å¼¹çª—
  function showConfirmModal() {
    const overlay = document.getElementById('modalOverlay');
    overlay.style.display = 'block';
    overlay.classList.add('show');
    document.getElementById('actionModal').style.display = 'none';
    document.getElementById('confirmModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  // éšè—æ‰€æœ‰å¼¹çª—
  function hideAllModals() {
    const overlay = document.getElementById('modalOverlay');
    overlay.style.display = 'none';
    overlay.classList.remove('show');
    document.getElementById('actionModal').style.display = 'none';
    document.getElementById('confirmModal').style.display = 'none';
    document.body.style.overflow = '';
    targetCell = null;
  }

  // ---------- çŠ¶æ€ç®¡ç†å‡½æ•° ----------
  function clearSelected() {
    if (selectedCell) {
      selectedCell.classList.remove('selected');
    }
    document.querySelectorAll('.course-cell').forEach(c => {
      c.classList.remove('merge-hover', 'copy-hover');
    });
    selectedCell = null;
    updateButtonStates();
  }

  function hideEditPanel() {
    document.getElementById('floatEditPanel').style.display = 'none';
    currentEditingCell = null;
  }

  function updateButtonStates() {
    const deleteBtn = document.getElementById('deleteBtn');
    const splitBtn = document.getElementById('splitBtn');
    
    if (deleteBtn) {
      deleteBtn.disabled = !(editingMode && selectedCell);
    }
    if (splitBtn) {
      splitBtn.disabled = !(editingMode && selectedCell && parseInt(selectedCell.dataset.mergeSize) > 1);
    }
  }

  function clearCell(cell) {
    if (!cell) return;
    cell.dataset.name = '';
    cell.dataset.location = '';
    cell.dataset.teacher = '';
    cell.dataset.type = 'none'; // æ¸…ç©ºæ—¶é‡ç½®ç±»å‹ä¸ºæ— 
    updateCellDisplay(cell, '', '', '', 'none');
    if (currentEditingCell === cell) hideEditPanel();
  }

  // ---------- åº•éƒ¨æŒ‰é’®æ¸²æŸ“ ----------
  function renderFooter() {
    const footer = document.getElementById('footerButtons');
    
    if (editingMode) {
      footer.innerHTML = `
        <button class="action-btn delete-btn" id="deleteBtn" disabled>ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­</button>
        <button class="action-btn split-btn" id="splitBtn" disabled>âœ‚ï¸ æ‹†åˆ†</button>
        <button class="action-btn save-all" id="saveAllBtn">ğŸ’¾ ä¿å­˜è¯¾è¡¨</button>
        <button class="action-btn clear-all" id="clearAllBtn">ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨</button>
        <button class="action-btn exit-edit" id="exitEditBtn">ğŸšª é€€å‡ºç¼–è¾‘</button>
      `;
      
      // åˆ é™¤é€‰ä¸­
      document.getElementById('deleteBtn').addEventListener('click', function() {
        if (selectedCell) {
          clearCell(selectedCell);
          updateButtonStates();
        }
      });
      
      // æ‹†åˆ†å•å…ƒæ ¼
      document.getElementById('splitBtn').addEventListener('click', function() {
        if (selectedCell && parseInt(selectedCell.dataset.mergeSize) > 1) {
          splitCell(selectedCell);
        }
      });
      
      // ä¿å­˜æ‰€æœ‰ï¼ˆåŒ…å«ç±»å‹ï¼‰
      document.getElementById('saveAllBtn').addEventListener('click', function() {
        const cells = document.querySelectorAll('.course-cell');
        const data = [];
        cells.forEach(cell => {
          data.push({
            name: cell.dataset.name || '',
            location: cell.dataset.location || '',
            teacher: cell.dataset.teacher || '',
            type: cell.dataset.type || 'none', // ä¿å­˜ç±»å‹
            mergeSize: cell.dataset.mergeSize || '1',
            lesson: cell.dataset.lesson,
            weekday: cell.dataset.weekday,
            mergedBy: cell.dataset.mergedBy || ''
          });
        });
        localStorage.setItem('courseTableData', JSON.stringify(data));
        alert('âœ… è¯¾è¡¨å·²ä¿å­˜ï¼ˆåŒ…å«è¯¾ç¨‹ç±»å‹ï¼‰');
      });
      
      // æ¸…ç©ºå…¨éƒ¨
      document.getElementById('clearAllBtn').addEventListener('click', function() {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è¯¾ç¨‹å—ï¼Ÿ')) {
          const cells = document.querySelectorAll('.course-cell');
          cells.forEach(cell => {
            cell.dataset.name = '';
            cell.dataset.location = '';
            cell.dataset.teacher = '';
            cell.dataset.type = 'none'; // é‡ç½®ç±»å‹
            cell.dataset.mergedBy = '';
            cell.classList.remove('merged');
            cell.dataset.mergeSize = '1';
            cell.rowSpan = 1;
            updateCellDisplay(cell, '', '', '', 'none');
          });
          clearSelected();
          hideEditPanel();
        }
      });
      
      // é€€å‡ºç¼–è¾‘
      document.getElementById('exitEditBtn').addEventListener('click', function() {
        editingMode = false;
        clearSelected();
        hideEditPanel();
        hideAllModals();
        document.querySelectorAll('.course-cell').forEach(c => {
          c.classList.remove('editable', 'selected', 'merge-hover', 'copy-hover');
        });
        renderFooter();
      });
      
      updateButtonStates();
    } else {
      footer.innerHTML = `<button class="action-btn edit-btn" id="editModeBtn">âœï¸ ç¼–è¾‘</button>`;
      document.getElementById('editModeBtn').addEventListener('click', function() {
        editingMode = true;
        clearSelected();
        document.querySelectorAll('.course-cell').forEach(c => c.classList.add('editable'));
        renderFooter();
      });
    }
  }

  // åŠ è½½æœ¬åœ°å­˜å‚¨æ•°æ®ï¼ˆåŒ…å«ç±»å‹ï¼‰
  function loadFromStorage() {
    const saved = localStorage.getItem('courseTableData');
    if (!saved) return;
    
    try {
      const data = JSON.parse(saved);
      const cells = document.querySelectorAll('.course-cell');
      cells.forEach((cell, i) => {
        if (data[i]) {
          cell.dataset.name = data[i].name || '';
          cell.dataset.location = data[i].location || '';
          cell.dataset.teacher = data[i].teacher || '';
          cell.dataset.type = data[i].type || 'none'; // åŠ è½½ç±»å‹
          cell.dataset.mergeSize = data[i].mergeSize || '1';
          cell.dataset.mergedBy = data[i].mergedBy || '';
          
          if (data[i].mergedBy) {
            cell.classList.add('merged');
          } else {
            cell.classList.remove('merged');
          }
          
          if (parseInt(cell.dataset.mergeSize) > 1) {
            cell.rowSpan = parseInt(cell.dataset.mergeSize);
          } else {
            cell.rowSpan = 1;
          }
          
          updateCellDisplay(cell, cell.dataset.name, cell.dataset.location, cell.dataset.teacher, cell.dataset.type);
        }
      });
    } catch (e) {
      console.error('åŠ è½½è¯¾è¡¨æ•°æ®å¤±è´¥:', e);
    }
  }

  // ---------- å…¨å±€çŠ¶æ€å˜é‡ ----------
  let editingMode = false;
  let currentEditingCell = null;
  let selectedCell = null;
  let targetCell = null;

  // ---------- åˆå§‹åŒ–äº‹ä»¶ç›‘å¬ ----------
  function initEventListeners() {
    const table = document.getElementById('courseTable');
    const floatEditPanel = document.getElementById('floatEditPanel');
    const editName = document.getElementById('editName');
    const editLocation = document.getElementById('editLocation');
    const editTeacher = document.getElementById('editTeacher');
    const editType = document.getElementById('editType'); // ç±»å‹é€‰æ‹©å™¨
    const wrap = document.querySelector('.wrap'); // è¯¾ç¨‹è¡¨å®¹å™¨
    
    // å•å…ƒæ ¼ç‚¹å‡»äº‹ä»¶
    table.addEventListener('click', function(e) {
      const cell = e.target.closest('.course-cell');
      if (!cell || !editingMode) return;
      
      // å¦‚æœå¼¹çª—å·²æ‰“å¼€ï¼Œä¸å¤„ç†ç‚¹å‡»
      if (document.getElementById('modalOverlay').style.display === 'block') {
        return;
      }

      // å¦‚æœç‚¹å‡»çš„æ˜¯å·²é€‰ä¸­çš„å•å…ƒæ ¼ï¼Œå–æ¶ˆé€‰ä¸­
      if (selectedCell === cell) {
        clearSelected();
        return;
      }

      // æ£€æŸ¥æ˜¯å¦æ˜¯è¦è¿›è¡Œåˆå¹¶/å¤åˆ¶æ“ä½œï¼ˆè¿™æ˜¯å”¯ä¸€ä¸å–æ¶ˆé€‰ä¸­çš„åœºæ™¯ï¼‰
      if (selectedCell && selectedCell !== cell) {
        // æ£€æŸ¥æ˜¯å¦å¯åˆå¹¶
        if (canMerge(selectedCell, cell)) {
          targetCell = cell;
          showActionModal(); // æ˜¾ç¤ºåˆå¹¶/å¤åˆ¶é€‰æ‹©å¼¹çª—
          return;
        } else {
          // ä¸å¯åˆå¹¶åˆ™æ˜¾ç¤ºå¤åˆ¶ç¡®è®¤å¼¹çª—
          targetCell = cell;
          showConfirmModal(); // æ˜¾ç¤ºå¤åˆ¶ç¡®è®¤å¼¹çª—
          return;
        }
      }

      // å…¶ä»–æƒ…å†µï¼šå…ˆå–æ¶ˆåŸæœ‰é€‰ä¸­ï¼Œå†é€‰ä¸­å½“å‰å•å…ƒæ ¼
      clearSelected();
      cell.classList.add('selected');
      selectedCell = cell;
      updateButtonStates();
    });

    // å…¨å±€ç‚¹å‡»äº‹ä»¶ï¼šç‚¹å‡»ä»»ä½•éæ´»åŠ¨åŒºåŸŸå–æ¶ˆé€‰ä¸­
    document.addEventListener('click', function(e) {
      // ç¼–è¾‘æ¨¡å¼æœªå¼€å¯ï¼Œä¸å¤„ç†
      if (!editingMode) return;
      
      // å¼¹çª—æ‰“å¼€æ—¶ï¼Œä¸å¤„ç†
      if (document.getElementById('modalOverlay').style.display === 'block') {
        return;
      }
      
      // ç¼–è¾‘é¢æ¿æ‰“å¼€æ—¶ï¼Œä¸å¤„ç†
      if (floatEditPanel.style.display === 'flex') {
        return;
      }

      // è·å–ç‚¹å‡»ç›®æ ‡
      const target = e.target;
      const cell = target.closest('.course-cell');

      // æƒ…å†µ1ï¼šç‚¹å‡»çš„æ˜¯å•å…ƒæ ¼ï¼ˆå·²åœ¨tableçš„clickäº‹ä»¶å¤„ç†ï¼‰
      if (cell) {
        return;
      }

      // æƒ…å†µ2ï¼šç‚¹å‡»çš„æ˜¯å…¶ä»–åŒºåŸŸï¼ˆåŒ…æ‹¬è¯¾ç¨‹è¡¨å†…çš„éå•å…ƒæ ¼åŒºåŸŸã€è¯¾ç¨‹è¡¨å¤–ï¼‰
      clearSelected();
    });

    // å•å…ƒæ ¼é¼ æ ‡æ‚¬æµ®äº‹ä»¶
    table.addEventListener('mouseover', function(e) {
      const cell = e.target.closest('.course-cell');
      if (!cell || !editingMode || !selectedCell || cell === selectedCell) return;
      if (document.getElementById('modalOverlay').style.display === 'block') return;
      
      if (canMerge(selectedCell, cell)) {
        cell.classList.add('merge-hover');
      } else {
        cell.classList.add('copy-hover');
      }
    });

    // å•å…ƒæ ¼é¼ æ ‡ç¦»å¼€äº‹ä»¶
    table.addEventListener('mouseout', function(e) {
      const cell = e.target.closest('.course-cell');
      if (cell) {
        cell.classList.remove('merge-hover', 'copy-hover');
      }
    });

    // å•å…ƒæ ¼åŒå‡»ç¼–è¾‘ï¼ˆåŠ è½½ç±»å‹ï¼‰
    table.addEventListener('dblclick', function(e) {
      const cell = e.target.closest('.course-cell');
      if (!cell || !editingMode) return;
      if (document.getElementById('modalOverlay').style.display === 'block') return;
      
      e.stopPropagation();
      editName.value = cell.dataset.name || '';
      editLocation.value = cell.dataset.location || '';
      editTeacher.value = cell.dataset.teacher || '';
      editType.value = cell.dataset.type || 'none'; // åŠ è½½å½“å‰ç±»å‹
      
      // å®šä½ç¼–è¾‘é¢æ¿
      const x = e.clientX, y = e.clientY;
      const panelWidth = 260, panelHeight = floatEditPanel.offsetHeight || 200;
      let left = x + 10, top = y + 10;
      
      if (left + panelWidth > window.innerWidth) left = x - panelWidth - 10;
      if (top + panelHeight > window.innerHeight) top = y - panelHeight - 10;
      if (left < 0) left = 10;
      if (top < 0) top = 10;
      
      floatEditPanel.style.left = left + 'px';
      floatEditPanel.style.top = top + 'px';
      floatEditPanel.style.display = 'flex';
      currentEditingCell = cell;
    });

    // ç¼–è¾‘é¢æ¿ä¿å­˜ï¼ˆä¿å­˜ç±»å‹ï¼‰
    document.getElementById('panelSave').addEventListener('click', function() {
      if (!currentEditingCell) return;
      
      const name = editName.value.trim();
      const location = editLocation.value.trim();
      const teacher = editTeacher.value.trim();
      const type = editType.value; // è·å–é€‰ä¸­çš„ç±»å‹
      
      currentEditingCell.dataset.name = name;
      currentEditingCell.dataset.location = location;
      currentEditingCell.dataset.teacher = teacher;
      currentEditingCell.dataset.type = type; // ä¿å­˜ç±»å‹
      updateCellDisplay(currentEditingCell, name, location, teacher, type);
      
      hideEditPanel();
    });

    // ç¼–è¾‘é¢æ¿å–æ¶ˆ
    document.getElementById('panelCancel').addEventListener('click', hideEditPanel);

    // æ“ä½œå¼¹çª— - åˆå¹¶æŒ‰é’®
    document.getElementById('modalMergeBtn').addEventListener('click', function() {
      if (selectedCell && targetCell) {
        mergeCells(selectedCell, targetCell);
      }
      hideAllModals();
    });

    // æ“ä½œå¼¹çª— - å¤åˆ¶æŒ‰é’®ï¼ˆå¤åˆ¶ç±»å‹ï¼‰
    document.getElementById('modalCopyBtn').addEventListener('click', function() {
      if (selectedCell && targetCell) {
        copyCourseInfo(selectedCell, targetCell);
        clearSelected();
        targetCell.classList.add('selected');
        selectedCell = targetCell;
        updateButtonStates();
      }
      hideAllModals();
    });

    // æ“ä½œå¼¹çª— - å–æ¶ˆæŒ‰é’®
    document.getElementById('modalCancelBtn').addEventListener('click', hideAllModals);

    // å¤åˆ¶ç¡®è®¤å¼¹çª— - ç¡®å®šæŒ‰é’®
    document.getElementById('confirmCopyBtn').addEventListener('click', function() {
      if (selectedCell && targetCell) {
        copyCourseInfo(selectedCell, targetCell);
        clearSelected();
        targetCell.classList.add('selected');
        selectedCell = targetCell;
        updateButtonStates();
      }
      hideAllModals();
    });

    // å¤åˆ¶ç¡®è®¤å¼¹çª— - å–æ¶ˆæŒ‰é’®
    document.getElementById('confirmCancelBtn').addEventListener('click', hideAllModals);

    // ç§»é™¤é®ç½©å±‚ç‚¹å‡»å…³é—­å¼¹çª—çš„åŠŸèƒ½
    // document.getElementById('modalOverlay').addEventListener('click', hideAllModals);

    // ç‚¹å‡»ç©ºç™½å¤„å…³é—­ç¼–è¾‘é¢æ¿
    document.addEventListener('click', function(e) {
      if (floatEditPanel.style.display !== 'flex') return;
      if (floatEditPanel.contains(e.target)) return;
      if (e.target.closest('.course-cell') === currentEditingCell) return;
      hideEditPanel();
    });
  }

  // ---------- åˆå§‹åŒ– ----------
  initMetadata();
  loadFromStorage();
  renderFooter();
  initEventListeners();

})();
</script>
</body>
</html>